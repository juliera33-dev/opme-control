<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de OPME - Akos Med</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... (mantenha seu CSS existente) ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <img src="logo_akosmed.png" alt="Akos Med Logo" class="header-logo">
                <div class="header-text">
                    <h1>Sistema de Controle de OPME</h1>
                    <p>Controle de Movimenta√ß√£o de √ìrteses, Pr√≥teses e Materiais Especiais</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>üìÑ Importar XML de NF-e</h2>
            <form id="uploadForm">
                <div class="form-group">
                    <label for="xmlFile">Selecione o arquivo XML:</label>
                    <input type="file" id="xmlFile" accept=".xml" required>
                </div>
                <div class="button-group">
                    <button type="submit">Importar XML</button>
                </div>
            </form>
            <div id="uploadMessage"></div>
        </div>
        
        <div class="card">
            <h2>üìä Consultar Saldo por Cliente</h2>
            <div class="form-group">
                <label for="cnpjCliente">CNPJ do Cliente (opcional):</label>
                <input type="text" id="cnpjCliente" placeholder="Digite o CNPJ do cliente ou deixe em branco para todos">
            </div>
            <div class="button-group">
                <button onclick="consultarSaldo()">Consultar Saldo</button>
                <button onclick="consultarMovimentacoes()">Ver Movimenta√ß√µes</button>
            </div>
            
            <div id="resultados"></div>
        </div>
    </div>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('xmlFile');
            const messageDiv = document.getElementById('uploadMessage');
            
            if (!fileInput.files[0]) {
                messageDiv.innerHTML = '<div class="error">Por favor, selecione um arquivo XML.</div>';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                messageDiv.innerHTML = '<div class="loading">Processando XML...</div>';
                
                const response = await fetch('api/upload_xml', {
                    method: 'POST',
                    body: formData
                });
                
                // Verifica√ß√£o de erro HTTP
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Erro HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                messageDiv.innerHTML = '<div class="success">' + result.message + '</div>';
                fileInput.value = '';
            } catch (error) {
                console.error("Erro no upload:", error);
                messageDiv.innerHTML = '<div class="error">Erro ao processar arquivo: ' + error.message + '</div>';
            }
        });
        
        async function consultarSaldo() {
            const cnpj = document.getElementById('cnpjCliente').value;
            const resultadosDiv = document.getElementById('resultados');
            
            try {
                resultadosDiv.innerHTML = '<div class="loading">Consultando saldo...</div>';
                
                const url = cnpj ? `api/balance?cnpj_cliente=${encodeURIComponent(cnpj)}` : 'api/balance';
                console.log("URL do saldo:", url);
                
                const response = await fetch(url);
                
                // Verifica√ß√£o de erro HTTP
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Dados do saldo:", data);
                
                if (data.length === 0) {
                    resultadosDiv.innerHTML = '<p>Nenhum saldo encontrado.</p>';
                    return;
                }
                
                let html = '<div class="results-header">';
                html += '<h3>Saldo de Materiais</h3>';
                html += `<span class="results-count">${data.length} ${data.length === 1 ? 'item' : 'itens'}</span>`;
                html += '</div>';
                html += '<div class="table-container">';
                html += '<table>';
                html += '<tr><th>Cliente</th><th>C√≥digo</th><th>Produto</th><th>Lote</th><th>Saldo</th></tr>';
                
                data.forEach(item => {
                    const saldoClass = item.saldo > 0 ? 'saldo-positivo' : (item.saldo < 0 ? 'saldo-negativo' : '');
                    html += `<tr>
                        <td>${item.nome_cliente}</td>
                        <td>${item.codigo_produto}</td>
                        <td>${item.descricao_produto}</td>
                        <td>${item.lote}</td>
                        <td><span class="${saldoClass}">${item.saldo}</span></td>
                    </tr>`;
                });
                
                html += '</table></div>';
                resultadosDiv.innerHTML = html;
            } catch (error) {
                console.error("Erro na consulta de saldo:", error);
                resultadosDiv.innerHTML = '<div class="error">Erro ao consultar saldo: ' + error.message + '</div>';
            }
        }
        
        async function consultarMovimentacoes() {
            const cnpj = document.getElementById('cnpjCliente').value;
            const resultadosDiv = document.getElementById('resultados');
            
            try {
                resultadosDiv.innerHTML = '<div class="loading">Consultando movimenta√ß√µes...</div>';
                
                const url = cnpj ? `api/movements?cnpj_cliente=${encodeURIComponent(cnpj)}` : 'api/movements';
                console.log("URL das movimenta√ß√µes:", url);
                
                const response = await fetch(url);
                
                // Verifica√ß√£o de erro HTTP
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Dados das movimenta√ß√µes:", data);
                
                if (data.length === 0) {
                    resultadosDiv.innerHTML = '<p>Nenhuma movimenta√ß√£o encontrada.</p>';
                    return;
                }
                
                let html = '<div class="results-header">';
                html += '<h3>Movimenta√ß√µes</h3>';
                html += `<span class="results-count">${data.length} ${data.length === 1 ? 'registro' : 'registros'}</span>`;
                html += '</div>';
                html += '<div class="table-container">';
                html += '<table>';
                html += '<tr><th>NF</th><th>Data</th><th>Cliente</th><th>C√≥digo</th><th>Produto</th><th>CFOP</th><th>Qtd</th><th>Lote</th></tr>';
                
                data.forEach(item => {
                    html += `<tr>
                        <td>${item.numero_nf}</td>
                        <td>${item.data_emissao}</td>
                        <td>${item.nome_cliente}</td>
                        <td>${item.codigo_produto}</td>
                        <td>${item.descricao_produto}</td>
                        <td>${item.cfop}</td>
                        <td>${item.quantidade}</td>
                        <td>${item.lote || 'N/A'}</td>
                    </tr>`;
                });
                
                html += '</table></div>';
                resultadosDiv.innerHTML = html;
            } catch (error) {
                console.error("Erro na consulta de movimenta√ß√µes:", error);
                resultadosDiv.innerHTML = '<div class="error">Erro ao consultar movimenta√ß√µes: ' + error.message + '</div>';
            }
        }
    </script>
</body>
</html>